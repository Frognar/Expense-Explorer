@page "/income"
@using System.Text.Json
@using ExpenseExplorer.API.Contract
@using ExpenseExplorer.API.Contract.ReadModel
@using ExpenseExplorer.GUI.Data
@using ExpenseExplorer.GUI.Helpers
@inject IHttpClientFactory ClientFactory
@rendermode InteractiveServer

<PageTitle>Income</PageTitle>
<RadzenButton
    ButtonStyle="ButtonStyle.Success"
    Icon="add_circle_outline"
    Text="Add New Income"
    Click="@InsertRow"
    Disabled="@(_incomesToInsert.Any() || _incomesToUpdate.Any() || _isLoading)"/>

<RadzenDataGrid
    @ref="_grid"
    Data="@_incomes"
    Count="@_count"
    TItem="IncomeModel"
    LoadData="@LoadData"
    AllowPaging="true"
    PagerHorizontalAlign="HorizontalAlign.Center"
    PageSizeOptions="@_pageSizeOptions"
    ShowPagingSummary="true"
    PagingSummaryFormat="Displaying page {0} of {1} <b>(total {2} records)</b>"
    AllowSorting="true"
    AllowFiltering="true"
    FilterMode="FilterMode.Simple"
    IsLoading=@_isLoading
    Density="Density.Compact"
    EditMode="DataGridEditMode.Single"
    RowCreate="@OnCreateRow"
    RowUpdate="@OnUpdateRow">
    <Columns>
        <RadzenDataGridColumn TItem="IncomeModel" Property="Source" Title="Source">
            <EditTemplate Context="income">
                <RadzenTextBox @bind-Value="income.Source"/>
            </EditTemplate>
            <FilterTemplate>
                <RadzenFormField AllowFloatingLabel="false" Text="Source">
                    <RadzenTextBox @bind-Value=@_source Change="OnSourceChange"/>
                </RadzenFormField>
            </FilterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="IncomeModel" Property="Amount" Title="Amount" FormatString="{0:0.00} zł">
            <EditTemplate Context="income">
                <RadzenNumeric TValue="decimal" @bind-Value="income.Amount"/>
            </EditTemplate>
            <FilterTemplate>
                <RadzenFormField AllowFloatingLabel="false" Text="Min amount">
                    <RadzenNumeric
                        ShowUpDown="false"
                        TValue="decimal?"
                        @bind-Value=@_minAmount
                        Change="OnMinAmountChange"/>
                </RadzenFormField>
                <RadzenFormField AllowFloatingLabel="false" Text="Max amount">
                    <RadzenNumeric
                        ShowUpDown="false"
                        TValue="decimal?"
                        @bind-Value=@_maxAmount
                        Change="OnMaxAmountChange"/>
                </RadzenFormField>
            </FilterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="IncomeModel" Property="Category" Title="Category">
            <EditTemplate Context="income">
                <RadzenTextBox @bind-Value="income.Category"/>
            </EditTemplate>
            <FilterTemplate>
                <RadzenFormField AllowFloatingLabel="false" Text="Category">
                    <RadzenTextBox @bind-Value=@_category Change="OnCategoryChange"/>
                </RadzenFormField>
            </FilterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn
            TItem="IncomeModel"
            Property="ReceivedDate"
            Title="Received date"
            FormatString="{0:dd.MM.yyyy}">
            <EditTemplate Context="income">
                <RadzenDatePicker @bind-Value="income.ReceivedDate" DateFormat="dd.MM.yyyy"/>
            </EditTemplate>
            <FilterTemplate>
                <RadzenFormField AllowFloatingLabel="false" Text="Received after">
                    <RadzenDatePicker
                        @bind-Value=@_receivedAfter
                        DateFormat="dd.MM.yyyy"
                        Change="OnReceivedAfterChange"/>
                </RadzenFormField>
                <RadzenFormField AllowFloatingLabel="false" Text="Received before">
                    <RadzenDatePicker
                        @bind-Value=@_receivedBefore
                        DateFormat="dd.MM.yyyy"
                        Change="OnReceivedBeforeChange"/>
                </RadzenFormField>
            </FilterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn TItem="IncomeModel" Property="Description" Title="Description">
            <EditTemplate Context="income">
                <RadzenTextBox @bind-Value="income.Description"/>
            </EditTemplate>
            <FilterTemplate>
                <RadzenFormField AllowFloatingLabel="false" Text="Description">
                    <RadzenTextBox @bind-Value=@_description Change="OnDescriptionChange"/>
                </RadzenFormField>
            </FilterTemplate>
        </RadzenDataGridColumn>
        <RadzenDataGridColumn
            Context="income"
            Filterable="false"
            Sortable="false"
            TextAlign="TextAlign.Right"
            Frozen="true"
            FrozenPosition="FrozenColumnPosition.Right">
            <Template Context="order">
                <RadzenButton
                    Icon="edit"
                    ButtonStyle="ButtonStyle.Light"
                    Variant="Variant.Flat"
                    Size="ButtonSize.Medium"
                    Click="@(_ => EditRow(order))"
                    @onclick:stopPropagation="true">
                </RadzenButton>
            </Template>
            <EditTemplate Context="income">
                <RadzenButton
                    Icon="check"
                    ButtonStyle="ButtonStyle.Success"
                    Variant="Variant.Flat"
                    Size="ButtonSize.Medium"
                    Click="@(_ => SaveRow(income))"/>
                <RadzenButton
                    Icon="close"
                    ButtonStyle="ButtonStyle.Light"
                    Variant="Variant.Flat"
                    Size="ButtonSize.Medium"
                    class="my-1 ms-1"
                    Click="@(_ => CancelEdit(income))"/>
            </EditTemplate>
        </RadzenDataGridColumn>
    </Columns>
</RadzenDataGrid>


@code
{
    private readonly IEnumerable<int> _pageSizeOptions = [10, 20, 30];
    private RadzenDataGrid<IncomeModel> _grid = default!;
    private IEnumerable<IncomeModel> _incomes = default!;
    private int _count;
    private bool _isLoading = true;
    private DateTime? _receivedAfter;
    private DateTime? _receivedBefore;
    private decimal? _minAmount;
    private decimal? _maxAmount;
    private string? _source;
    private string? _category;
    private string? _description;

    private readonly List<IncomeModel> _incomesToInsert = [];
    private readonly List<IncomeModel> _incomesToUpdate = [];
    private IncomeModel? _editBackup;

    private async Task LoadData(LoadDataArgs args)
    {
        _isLoading = true;
        string url = $"http://localhost:5163/api/incomes?{GetParameters(args)}";
        using HttpClient client = ClientFactory.CreateClient();
        GetIncomesResponse? response = await client.GetFromJsonAsync<GetIncomesResponse>(url);
        if (response is not null)
        {
            _count = response.FilteredCount;
            _incomes = response.Incomes.Select(income => income.ToViewModel());
        }

        _isLoading = false;
    }

    private string GetParameters(LoadDataArgs args)
    {
        QueryParameters parameters = new();
        (int pageNumber, int pageSize) = args.GetPagingParameters();
        parameters.Add(pageNumber, "pageNumber");
        parameters.Add(pageSize, "pageSize");
        (string? sortBy, string? sortOrder) = args.GetOrderByParameters();
        parameters.Add(sortBy, "sortBy");
        parameters.Add(sortOrder, "sortOrder");
        parameters.Add(_minAmount, "minAmount");
        parameters.Add(_maxAmount, "maxAmount");
        parameters.Add(_receivedAfter, "receivedAfter");
        parameters.Add(_receivedBefore, "receivedBefore");
        parameters.Add(_source, "source");
        parameters.Add(_category, "category");
        parameters.Add(_description, "description");
        return parameters.ToString();
    }

    private async Task OnReceivedAfterChange(DateTime? _) => await _grid.Reload();

    private async Task OnReceivedBeforeChange(DateTime? _) => await _grid.Reload();

    private async Task OnMinAmountChange(decimal? _) => await _grid.Reload();

    private async Task OnMaxAmountChange(decimal? _) => await _grid.Reload();

    private async Task OnSourceChange(string _) => await _grid.Reload();

    private async Task OnCategoryChange(string _) => await _grid.Reload();

    private async Task OnDescriptionChange(string _) => await _grid.Reload();

    async Task SaveRow(IncomeModel income)
    {
        await _grid.UpdateRow(income);
    }

    void CancelEdit(IncomeModel income)
    {
        _incomesToInsert.Clear();
        _incomesToUpdate.Clear();
        if (_editBackup is not null)
        {
            income.Source = _editBackup.Source;
            income.Amount = _editBackup.Amount;
            income.Category = _editBackup.Category;
            income.ReceivedDate = _editBackup.ReceivedDate;
            income.Description = _editBackup.Description;
        }

        _grid.CancelEditRow(income);
    }

    async Task InsertRow()
    {
        _incomesToInsert.Clear();
        _incomesToUpdate.Clear();
        IncomeModel income = new();
        _incomesToInsert.Add(income);
        await _grid.InsertRow(income);
    }

    private async Task OnCreateRow(IncomeModel income)
    {
        string url = "http://localhost:5163/api/incomes";
        using HttpClient client = ClientFactory.CreateClient();
        HttpResponseMessage responseMessage = await client.PostAsJsonAsync(url, income.ToAddRequest());
        if (responseMessage.IsSuccessStatusCode)
        {
            string content = await responseMessage.Content.ReadAsStringAsync();
            AddIncomeResponse response = JsonSerializer
                .Deserialize<AddIncomeResponse>(content, new JsonSerializerOptions { PropertyNameCaseInsensitive = true })!;

            income.Id = response.Id;
        }
        else
        {
            _grid.CancelEditRow(income);
        }

        _incomesToInsert.Clear();
        _incomesToUpdate.Clear();
    }

    private async Task EditRow(IncomeModel income)
    {
        _incomesToInsert.Clear();
        _incomesToUpdate.Clear();
        _incomesToUpdate.Add(income);
        await _grid.EditRow(income);
        _editBackup = income.MakeCopy();
    }

    private async Task OnUpdateRow(IncomeModel income)
    {
        string url = $"http://localhost:5163/api/incomes/{income.Id}";
        using HttpClient client = ClientFactory.CreateClient();
        HttpResponseMessage responseMessage = await client.PatchAsJsonAsync(url, income.ToEditRequest());
        if (!responseMessage.IsSuccessStatusCode)
        {
            income.CopyFrom(_editBackup!);
            _grid.CancelEditRow(income);
        }

        _editBackup = null;
        _incomesToInsert.Clear();
        _incomesToUpdate.Clear();
    }
}
